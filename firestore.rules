/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership and group-membership model for data access.
 *
 * Data Structure:
 * - User-specific data is nested under /users/{userId}.
 * - Startup-specific data is nested under /startups/{startupId}.
 * - Signals (notifications) are segregated into user-specific (/users/{userId}/signals) and startup-specific (/startups/{startupId}/signals) collections.
 *
 * Key Security Decisions:
 * - User listing is disabled.
 * - Write access is strictly controlled based on ownership or group membership.
 *
 * Denormalization for Authorization:
 * - Startup-specific signals denormalize the `startupMembers` map to simplify access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows the creation, reading, updating, and deletion of startup documents.
     * @path /startups/{startupId}
     * @allow (create, update, delete) if isSignedIn()
     * @allow (get, list) if true;
     * @deny (create) if false;
     * @principle Allows creation, read, update, and delete for authenticated users.
     */
    match /startups/{startupId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows the creation, reading, updating, and deletion of milestone documents within a startup.
     * @path /startups/{startupId}/milestones/{milestoneId}
     * @allow (create, update, delete) if isSignedIn()
     * @allow (get, list) if isSignedIn()
     * @deny (create) if false;
     * @principle Allows creation, read, update, and delete for authenticated users within a startup.
     */
    match /startups/{startupId}/milestones/{milestoneId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows the reading of course documents.
     * @path /courses/{courseId}
     * @allow (get, list) if true;
     * @deny (create, update, delete) if false;
     * @principle Allows public read access to courses.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows the creation, reading, updating, and deletion of freelancer documents.
     * @path /freelancers/{freelancerId}
     * @allow (create, update, delete) if isSignedIn()
     * @allow (get, list) if true;
     * @deny (create) if false;
     * @principle Allows creation, read, update, and delete for authenticated users.
     */
    match /freelancers/{freelancerId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows the creation, reading, updating, and deletion of project documents within a startup.
     * @path /startups/{startupId}/projects/{projectId}
     * @allow (create, update, delete) if isSignedIn()
     * @allow (get, list) if isSignedIn()
     * @deny (create) if false;
     * @principle Allows creation, read, update, and delete for authenticated users within a startup.
     */
    match /startups/{startupId}/projects/{projectId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows the creation, reading, updating, and deletion of user documents.
     * @path /users/{userId}
     * @allow create: if request.auth.uid == userId;
     * @allow get: if isSignedIn();
     * @allow update: if isOwner(userId) && resource != null;
     * @allow delete: if isOwner(userId) && resource != null;
     * @deny list: if true;
     * @principle Enforces document ownership for writes and prevents user listing.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if request.auth.uid == userId;
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Allows the creation, reading, updating, and deletion of post documents within a user's profile.
     * @path /users/{userId}/posts/{postId}
     * @allow (create, update, delete) if isOwner(userId)
     * @allow (get, list) if isOwner(userId)
     * @deny (create) if false;
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/posts/{postId} {
      allow get, list: if isOwner(userId);
      allow create, update, delete: if isOwner(userId);
    }

    /**
     * @description Allows the creation, reading, updating, and deletion of company documents.
     * @path /companies/{companyId}
     * @allow (create, update, delete) if isSignedIn()
     * @allow (get, list) if true;
     * @deny (create) if false;
     * @principle Allows creation, read, update, and delete for authenticated users.
     */
    match /companies/{companyId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows the creation, reading, updating, and deletion of ticket documents within a company.
     * @path /companies/{companyId}/tickets/{ticketId}
     * @allow (create, update, delete) if isSignedIn()
     * @allow (get, list) if isSignedIn()
     * @deny (create) if false;
     * @principle Allows creation, read, update, and delete for authenticated users within a company.
     */
    match /companies/{companyId}/tickets/{ticketId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows the creation, reading, updating, and deletion of teamMember documents within a company.
     * @path /companies/{companyId}/teamMembers/{teamMemberId}
     * @allow (create, update, delete) if isSignedIn()
     * @allow (get, list) if isSignedIn()
     * @deny (create) if false;
     * @principle Allows creation, read, update, and delete for authenticated users within a company.
     */
    match /companies/{companyId}/teamMembers/{teamMemberId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows the creation, reading, updating, and deletion of user-specific signal documents.
     * @path /users/{userId}/signals/{signalId}
     * @allow (create, update, delete) if isOwner(userId)
     * @allow (get, list) if isOwner(userId)
     * @deny (create) if false;
     * @principle Enforces document ownership for writes and restricts access to a user's own signals.
     */
    match /users/{userId}/signals/{signalId} {
      allow get, list: if isOwner(userId);
      allow create, update, delete: if isOwner(userId);
    }

    /**
     * @description Allows the creation, reading, updating, and deletion of startup-specific signal documents.
     * @path /startups/{startupId}/signals/{signalId}
     * @allow (create, update, delete) if isSignedIn()
     * @allow (get, list) if isSignedIn()
     * @deny (create) if false;
     */
    match /startups/{startupId}/signals/{signalId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }
  }

  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }
}