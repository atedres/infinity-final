/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for personal data and a role-based access model for collaborative data, ensuring that users can only access their own resources unless explicitly granted permission through a shared access mechanism.
 *
 * Data Structure:
 * - User-specific data is nested under /users/{userId}
 * - Startup-specific data is nested under /startups/{startupId}
 * - Company-specific data is nested under /companies/{companyId}
 *
 * Key Security Decisions:
 * - Listing of top-level collections (e.g., /startups, /freelancers, /courses, /companies) is allowed for all users.
 * - User listing is disabled.
 * - Data validation is minimal, focusing on authorization and relational integrity.
 *
 * Denormalization for Authorization:
 * - Startup signals denormalize a 'startupMembers' map to enable efficient role-based access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read the startup data. Only allows authenticated users to create a startup, but they must also be the owner. Only the startup owner can update or delete a startup.
     * @path /startups/{startupId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
     * @allow update, delete: if isSignedIn() && isExistingOwner(startupId);
     * @deny create: if !isSignedIn() || request.resource.data.id != request.auth.uid;
     * @deny update, delete: if !isSignedIn() || !isExistingOwner(startupId);
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /startups/{startupId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(startupId);

      /**
       * @description Allows a startup owner to create milestones. Only the startup owner can read, update, or delete a milestone.
       * @path /startups/{startupId}/milestones/{milestoneId}
       * @allow get, list: if isSignedIn() && isOwner(startupId);
       * @allow create: if isSignedIn() && isOwner(startupId);
       * @allow update, delete: if isSignedIn() && isExistingOwner(startupId);
       * @deny create: if !isSignedIn() || !isOwner(startupId);
       * @deny update, delete: if !isSignedIn() || !isExistingOwner(startupId);
       * @principle Enforces document ownership for writes, restricts access to the owner.
       */
      match /milestones/{milestoneId} {
        allow get, list: if isSignedIn() && isOwner(startupId);
        allow create: if isSignedIn() && isOwner(startupId);
        allow update, delete: if isSignedIn() && isExistingOwner(startupId);
      }

      /**
       * @description Allows a startup owner to create projects. Only the startup owner can read, update, or delete a project.
       * @path /startups/{startupId}/projects/{projectId}
       * @allow get, list: if isSignedIn() && isOwner(startupId);
       * @allow create: if isSignedIn() && isOwner(startupId);
       * @allow update, delete: if isSignedIn() && isExistingOwner(startupId);
       * @deny create: if !isSignedIn() || !isOwner(startupId);
       * @deny update, delete: if !isSignedIn() || !isExistingOwner(startupId);
       * @principle Enforces document ownership for writes, restricts access to the owner.
       */
      match /projects/{projectId} {
        allow get, list: if isSignedIn() && isOwner(startupId);
        allow create: if isSignedIn() && isOwner(startupId);
        allow update, delete: if isSignedIn() && isExistingOwner(startupId);
      }

       /**
         * @description Allows any member of a startup to read startup signals, and only the startup itself to create, update, and delete.
         * @path /startups/{startupId}/signals/{signalId}
         * @allow get, list: if isSignedIn() && resource.data.startupMembers[request.auth.uid] != null;
         * @allow create, update, delete: if isSignedIn() && isOwner(startupId);
         * @deny get, list: if !isSignedIn() || resource.data.startupMembers[request.auth.uid] == null;
         * @deny create, update, delete: if !isSignedIn() || !isOwner(startupId);
         * @principle Enforces document ownership for writes, allows shared reads for startup members.
         */
      match /signals/{signalId} {
          allow get, list: if isSignedIn() && resource.data.startupMembers[request.auth.uid] != null;
          allow create, update, delete: if isSignedIn() && isOwner(startupId);
      }
    }

    /**
     * @description Allows anyone to read the course data. Only allows authenticated users to create a course, but they must also be the owner. Only the course owner can update or delete a course.
     * @path /courses/{courseId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
     * @allow update, delete: if isSignedIn() && isExistingOwner(courseId);
     * @deny create: if !isSignedIn() || request.resource.data.id != request.auth.uid;
     * @deny update, delete: if !isSignedIn() || !isExistingOwner(courseId);
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(courseId);
    }

    /**
     * @description Allows anyone to read the freelancer data. Only allows authenticated users to create a freelancer, but they must also be the owner. Only the freelancer owner can update or delete a freelancer.
     * @path /freelancers/{freelancerId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
     * @allow update, delete: if isSignedIn() && isExistingOwner(freelancerId);
     * @deny create: if !isSignedIn() || request.resource.data.id != request.auth.uid;
     * @deny update, delete: if !isSignedIn() || !isExistingOwner(freelancerId);
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /freelancers/{freelancerId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(freelancerId);
    }

    /**
     * @description Allows a user to read their own profile. Allows a user to create their own profile. Only the user can update or delete their own profile.
     * @path /users/{userId}
     * @allow get: if isOwner(userId);
     * @allow list: if false;
     * @allow create: if isSignedIn() && isOwner(userId) && request.auth.uid == userId;
     * @allow update, delete: if isSignedIn() && isExistingOwner(userId) && request.auth.uid == userId;
     * @deny create: if !isSignedIn() || !isOwner(userId) || request.auth.uid != userId;
     * @deny update, delete: if !isSignedIn() || !isExistingOwner(userId) || request.auth.uid != userId;
     * @principle Enforces document ownership for writes, restricts access to the owner.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.auth.uid == userId;
      allow update, delete: if isSignedIn() && isExistingOwner(userId) && request.auth.uid == userId;

      /**
       * @description Allows a user to create their own posts. Only the user can read, update, or delete their own posts.
       * @path /users/{userId}/posts/{postId}
       * @allow get, list: if isOwner(userId);
       * @allow create: if isSignedIn() && isOwner(userId);
       * @allow update, delete: if isSignedIn() && isExistingOwner(userId);
       * @deny create: if !isSignedIn() || !isOwner(userId);
       * @deny update, delete: if !isSignedIn() || !isExistingOwner(userId);
       * @principle Enforces document ownership for writes, restricts access to the owner.
       */
      match /posts/{postId} {
        allow get, list: if isOwner(userId);
        allow create: if isSignedIn() && isOwner(userId);
        allow update, delete: if isSignedIn() && isExistingOwner(userId);
      }

      /**
       * @description Allows a user to create their own signals. Only the user can read, update, or delete their own signals.
       * @path /users/{userId}/signals/{signalId}
       * @allow get, list: if isOwner(userId);
       * @allow create: if isSignedIn() && isOwner(userId);
       * @allow update, delete: if isSignedIn() && isExistingOwner(userId);
       * @deny create: if !isSignedIn() || !isOwner(userId);
       * @deny update, delete: if !isSignedIn() || !isExistingOwner(userId);
       * @principle Enforces document ownership for writes, restricts access to the owner.
       */
        match /signals/{signalId} {
          allow get, list: if isOwner(userId);
          allow create: if isSignedIn() && isOwner(userId);
          allow update, delete: if isSignedIn() && isExistingOwner(userId);
        }
    }

    /**
     * @description Allows anyone to read the company data. Only allows authenticated users to create a company, but they must also be the owner. Only the company owner can update or delete a company.
     * @path /companies/{companyId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
     * @allow update, delete: if isSignedIn() && isExistingOwner(companyId);
     * @deny create: if !isSignedIn() || request.resource.data.id != request.auth.uid;
     * @deny update, delete: if !isSignedIn() || !isExistingOwner(companyId);
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /companies/{companyId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(companyId);

      /**
       * @description Allows a company owner to create tickets. Only the company owner can read, update, or delete a ticket.
       * @path /companies/{companyId}/tickets/{ticketId}
       * @allow get, list: if isSignedIn() && isOwner(companyId);
       * @allow create: if isSignedIn() && isOwner(companyId);
       * @allow update, delete: if isSignedIn() && isExistingOwner(companyId);
       * @deny create: if !isSignedIn() || !isOwner(companyId);
       * @deny update, delete: if !isSignedIn() || !isExistingOwner(companyId);
       * @principle Enforces document ownership for writes, restricts access to the owner.
       */
      match /tickets/{ticketId} {
        allow get, list: if isSignedIn() && isOwner(companyId);
        allow create: if isSignedIn() && isOwner(companyId);
        allow update, delete: if isSignedIn() && isExistingOwner(companyId);
      }

      /**
       * @description Allows a company owner to create team members. Only the company owner can read, update, or delete a team member.
       * @path /companies/{companyId}/teamMembers/{teamMemberId}
       * @allow get, list: if isSignedIn() && isOwner(companyId);
       * @allow create: if isSignedIn() && isOwner(companyId);
       * @allow update, delete: if isSignedIn() && isExistingOwner(companyId);
       * @deny create: if !isSignedIn() || !isOwner(companyId);
       * @deny update, delete: if !isSignedIn() || !isExistingOwner(companyId);
       * @principle Enforces document ownership for writes, restricts access to the owner.
       */
      match /teamMembers/{teamMemberId} {
        allow get, list: if isSignedIn() && isOwner(companyId);
        allow create: if isSignedIn() && isOwner(companyId);
        allow update, delete: if isSignedIn() && isExistingOwner(companyId);
      }
    }

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document, based on the userId.
     * @param {string} userId The user ID to check against.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the existing document, based on the userId and confirms that the resource exists.
     * @param {string} userId The user ID to check against.
     * @return {boolean} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}