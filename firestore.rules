/**
 * @fileoverview Firestore Security Rules for the Infinity Software application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict ownership model for user-specific data and a role-based access control model for startup-related data.
 * The primary goal is to protect user privacy and ensure that only authorized individuals can access and modify data.
 *
 * Data Structure:
 * - User-specific data is nested under `/users/{userId}`, enforcing that only the authenticated user can access their own data.
 * - Startup-related data is stored under `/startups/{startupId}`, with access controlled through a denormalized membership map.
 * - Other top-level collections (e.g., `/courses`, `/freelancers`, `/companies`) have individual access controls as defined below.
 *
 * Key Security Decisions:
 * - Listing all users or all startups is disallowed for security and privacy reasons.
 * - Data validation is relaxed to allow for rapid prototyping, focusing on authorization and relationship integrity.
 * - Authorization decisions are based on the authenticated user's UID (`request.auth.uid`).
 *
 * Denormalization for Authorization:
 * - Startup signals denormalize the startup's `members` map into the `startupMembers` field on each signal document. This allows checking a user's role within a startup directly within the signal's rules, without needing to perform additional `get()` operations.
 *
 * Structural Segregation:
 * - Signals are stored either under a user's document (`/users/{userId}/signals`) or a startup's document (`/startups/{startupId}/signals`), depending on whether they are user-specific or startup-related. This segregation is crucial for implementing secure list operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of an existing document.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user is a member of a startup with a specific role.
     */
    function isStartupMember(startupId, role) {
        return get(/databases/$(database)/documents/startups/$(startupId)).data.members[request.auth.uid] == role;
    }

    /**
     * @description Grants owner-only access to documents in the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) - Authenticated user with UID 'user123' can create a document at /users/user123.
     * @allow (get) - Authenticated user with UID 'user123' can read a document at /users/user123.
     * @allow (update) - Authenticated user with UID 'user123' can update a document at /users/user123.
     * @allow (delete) - Authenticated user with UID 'user123' can delete a document at /users/user123.
     * @deny (create) - Authenticated user with UID 'user456' cannot create a document at /users/user123.
     * @principle Enforces document ownership for writes and reads.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants owner-only access to documents in the /users/{userId}/posts/{postId} collection.
     * @path /users/{userId}/posts/{postId}
     * @allow (create) - Authenticated user with UID 'user123' can create a document at /users/user123/posts/post456.
     * @allow (get) - Authenticated user with UID 'user123' can read a document at /users/user123/posts/post456.
     * @allow (update) - Authenticated user with UID 'user123' can update a document at /users/user123/posts/post456.
     * @allow (delete) - Authenticated user with UID 'user123' can delete a document at /users/user123/posts/post456.
     * @deny (create) - Authenticated user with UID 'user456' cannot create a document at /users/user123/posts/post456.
     * @principle Enforces document ownership for writes and reads within a user's data tree.
     */
    match /users/{userId}/posts/{postId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants owner-only access to documents in the /users/{userId}/signals/{signalId} collection.
     * @path /users/{userId}/signals/{signalId}
     * @allow (create) - Authenticated user with UID 'user123' can create a document at /users/user123/signals/signal456.
     * @allow (get) - Authenticated user with UID 'user123' can read a document at /users/user123/signals/signal456.
     * @allow (update) - Authenticated user with UID 'user123' can update a document at /users/user123/signals/signal456.
     * @allow (delete) - Authenticated user with UID 'user123' can delete a document at /users/user123/signals/signal456.
     * @deny (create) - Authenticated user with UID 'user456' cannot create a document at /users/user123/signals/signal456.
     * @principle Enforces document ownership for writes and reads within a user's data tree.
     */
    match /users/{userId}/signals/{signalId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access and owner-only write access to documents in the /startups/{startupId} collection.
     * @path /startups/{startupId}
     * @allow (get) - Any user can read a document at /startups/startup123.
     * @allow (list) - Any user can list documents in /startups.
     * @allow (create) - Authenticated user with UID 'user123' can create a document at /startups/startup123 if request.resource.data.id == 'startup123'.
     * @allow (update) - Authenticated user with UID 'user123' can update a document at /startups/startup123 if the existing document's id is 'startup123'.
     * @allow (delete) - Authenticated user with UID 'user123' can delete a document at /startups/startup123 if the existing document's id is 'startup123'.
     * @deny (create) - Authenticated user with UID 'user123' cannot create a document at /startups/startup123 if request.resource.data.id != 'startup123'.
     * @principle Allows public reads but restricts writes to the owner, enforcing relational integrity on create and immutability of the owner field on update.
     */
    match /startups/{startupId} {
      allow get: if true;
      allow list: if true;
      allow create: if request.resource.data.id == startupId && isSignedIn();
      allow update: if resource.data.id == startupId && isSignedIn();
      allow delete: if resource.data.id == startupId && isSignedIn();
    }

    /**
     * @description Grants access to documents in the /startups/{startupId}/milestones/{milestoneId} collection based on startup membership.
     * @path /startups/{startupId}/milestones/{milestoneId}
     */
    match /startups/{startupId}/milestones/{milestoneId} {
      allow get: if isStartupMember(startupId, 'editor') || isStartupMember(startupId, 'owner');
      allow list: if isStartupMember(startupId, 'editor') || isStartupMember(startupId, 'owner');
      allow create: if isStartupMember(startupId, 'owner');
      allow update: if isStartupMember(startupId, 'editor') && resource != null;
      allow delete: if isStartupMember(startupId, 'owner') && resource != null;
    }

    /**
     * @description Grants access to documents in the /startups/{startupId}/projects/{projectId} collection based on startup membership.
     * @path /startups/{startupId}/projects/{projectId}
     */
    match /startups/{startupId}/projects/{projectId} {
      allow get: if isStartupMember(startupId, 'editor') || isStartupMember(startupId, 'owner');
      allow list: if isStartupMember(startupId, 'editor') || isStartupMember(startupId, 'owner');
      allow create: if isStartupMember(startupId, 'owner');
      allow update: if isStartupMember(startupId, 'editor') && resource != null;
      allow delete: if isStartupMember(startupId, 'owner') && resource != null;
    }

    /**
     * @description Grants access to documents in the /startups/{startupId}/signals/{signalId} collection based on startup membership.
     * @path /startups/{startupId}/signals/{signalId}
     */
    match /startups/{startupId}/signals/{signalId} {
      allow get: if isStartupMember(startupId, 'editor') || isStartupMember(startupId, 'owner');
      allow list: if isStartupMember(startupId, 'editor') || isStartupMember(startupId, 'owner');
      allow create: if isStartupMember(startupId, 'owner');
      allow update: if isStartupMember(startupId, 'editor') && resource != null;
      allow delete: if isStartupMember(startupId, 'owner') && resource != null;
    }

    /**
     * @description Allows public read access to documents in the /courses/{courseId} collection.
     * @path /courses/{courseId}
     */
    match /courses/{courseId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to documents in the /freelancers/{freelancerId} collection.
     * @path /freelancers/{freelancerId}
     */
    match /freelancers/{freelancerId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to documents in the /companies/{companyId} collection.
     * @path /companies/{companyId}
     */
    match /companies/{companyId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants access to documents in the /companies/{companyId}/tickets/{ticketId} collection based on company membership.
     * @path /companies/{companyId}/tickets/{ticketId}
     */
    match /companies/{companyId}/tickets/{ticketId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants access to documents in the /companies/{companyId}/teamMembers/{teamMemberId} collection based on company membership.
     * @path /companies/{companyId}/teamMembers/{teamMemberId}
     */
    match /companies/{companyId}/teamMembers/{teamMemberId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}