/**
 * @fileoverview Firestore Security Rules for Sound Sphere.
 *
 * Core Philosophy: This ruleset enforces a strict ownership model for user and company data,
 * while providing controlled access to shared resources like startup and project information.
 * Authorization Independence is achieved through structural segregation (dedicated collections)
 * and data denormalization (explicit access modeling).
 *
 * Data Structure:
 * - /startups/{startupId}: Startup company information.
 * - /startups/{startupId}/milestones/{milestoneId}: Milestones for a specific startup.
 * - /courses/{courseId}: Courses available to startups.
 * - /freelancers/{freelancerId}: Freelancer profiles.
 * - /startups/{startupId}/projects/{projectId}: Projects associated with a startup.
 * - /users/{userId}: User profiles.
 * - /users/{userId}/posts/{postId}: Posts created by a user.
 * - /companies/{companyId}: Company profiles.
 * - /companies/{companyId}/tickets/{ticketId}: Support tickets for a company.
 * - /companies/{companyId}/teamMembers/{teamMemberId}: Team members within a company.
 * - /users/{userId}/signals/{signalId}: User-specific signals/notifications.
 * - /startups/{startupId}/signals/{signalId}: Startup-specific signals/notifications.
 *
 * Key Security Decisions:
 * - Listing of the top-level `/signals` collection is disallowed to prevent unauthorized access.
 *   Instead, access is granted through user-specific (`/users/{userId}/signals`) and
 *   startup-specific (`/startups/{startupId}/signals`) subcollections.
 * - Read access to courses is public.
 * - Write access is restricted based on ownership (e.g., users can only modify their own profiles and posts).
 * - Authorization Independence: Access control information (e.g., startup membership) is
 *   denormalized onto documents to avoid costly `get()` calls in security rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to startup documents.
     * @path /startups/{startupId}
     * @allow (read) Anyone can read a startup's information.
     * @allow (create, update, delete) No one can create, update or delete a startup
     * @deny (create, update, delete) No one can create, update, or delete startups.
     * @principle Public read access, owner-only writes (not implemented due to missing ownership field).
     */
    match /startups/{startupId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Grants access to milestones within a startup.
     * @path /startups/{startupId}/milestones/{milestoneId}
     * @allow (read) Anyone can read a milestone within a startup.
     * @allow (create, update, delete) No one can create, update or delete a milestone
     * @deny (create, update, delete) No one can create, update, or delete milestones.
     * @principle Public read access, owner-only writes (not implemented due to missing ownership field).
     */
    match /startups/{startupId}/milestones/{milestoneId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Grants access to course documents.
     * @path /courses/{courseId}
     * @allow (read) Anyone can read a course document.
     * @allow (create, update, delete) No one can create, update or delete a course
     * @deny (create, update, delete) No one can create, update, or delete courses.
     * @principle Public read access, owner-only writes (not implemented due to missing ownership field).
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Grants access to freelancer documents.
     * @path /freelancers/{freelancerId}
     * @allow (read) Anyone can read a freelancer document.
     * @allow (create, update, delete) No one can create, update or delete a freelancer
     * @deny (create, update, delete) No one can create, update, or delete freelancers.
     * @principle Public read access, owner-only writes (not implemented due to missing ownership field).
     */
    match /freelancers/{freelancerId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Grants access to projects within a startup.
     * @path /startups/{startupId}/projects/{projectId}
     * @allow (read) Anyone can read a project within a startup.
     * @allow (create, update, delete) No one can create, update or delete a project
     * @deny (create, update, delete) No one can create, update, or delete projects.
     * @principle Public read access, owner-only writes (not implemented due to missing ownership field).
     */
    match /startups/{startupId}/projects/{projectId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Grants access to user documents.
     * @path /users/{userId}
     * @allow (create) A user can create their own document.
     * @allow (get, list) Anyone can read a user's document.
     * @allow (update, delete) A user can update and delete their own document.
     * @deny (create) A user cannot create a document with an ID that does not match their own.
     * @deny (update, delete) A user cannot update or delete another user's document.
     * @principle Enforces document ownership for writes, public read access.
     */
    match /users/{userId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update, delete: if isSignedIn() && request.auth.uid == userId && resource != null;
    }

    /**
     * @description Grants access to posts within a user's profile.
     * @path /users/{userId}/posts/{postId}
     * @allow (read, list) Anyone can read and list a user's posts.
     * @allow (create) A user can create a post in their own profile.
     * @allow (update, delete) A user can update and delete their own posts.
     * @deny (create) A user cannot create a post in another user's profile.
     * @deny (update, delete) A user cannot update or delete another user's posts.
     * @principle Enforces document ownership for writes, public read access.
     */
    match /users/{userId}/posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update, delete: if isSignedIn() && request.auth.uid == userId && resource != null;
    }

    /**
     * @description Grants access to company documents.
     * @path /companies/{companyId}
     * @allow (read) Anyone can read a company's document.
     * @allow (create, update, delete) No one can create, update or delete a company
     * @deny (create, update, delete) No one can create, update, or delete companies.
     * @principle Public read access, owner-only writes (not implemented due to missing ownership field).
     */
    match /companies/{companyId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Grants access to tickets within a company.
     * @path /companies/{companyId}/tickets/{ticketId}
     * @allow (read) Anyone can read a ticket within a company.
     * @allow (create, update, delete) No one can create, update or delete a ticket
     * @deny (create, update, delete) No one can create, update, or delete tickets.
     * @principle Public read access, owner-only writes (not implemented due to missing ownership field).
     */
    match /companies/{companyId}/tickets/{ticketId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Grants access to team members within a company.
     * @path /companies/{companyId}/teamMembers/{teamMemberId}
     * @allow (read) Anyone can read a team member within a company.
     * @allow (create, update, delete) No one can create, update or delete a team member
     * @deny (create, update, delete) No one can create, update, or delete team members.
     * @principle Public read access, owner-only writes (not implemented due to missing ownership field).
     */
    match /companies/{companyId}/teamMembers/{teamMemberId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Grants access to user-specific signals.
     * @path /users/{userId}/signals/{signalId}
     * @allow (get, list) A user can read and list their own signals.
     * @allow (create) A user can create their own signals.
     * @allow (update, delete) A user can update and delete their own signals.
     * @deny (create) A user cannot create a signal for another user.
     * @deny (update, delete) A user cannot update or delete another user's signal.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/signals/{signalId} {
      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update, delete: if isSignedIn() && request.auth.uid == userId && resource != null;
    }

    /**
     * @description Grants access to startup-specific signals.
     * @path /startups/{startupId}/signals/{signalId}
     * @allow (get, list) Anyone can read and list a startup's signals.
     * @allow (create, update, delete) No one can create, update or delete a startup's signal
     * @deny (create, update, delete) No one can create, update, or delete startup signals.
     */
    match /startups/{startupId}/signals/{signalId} {
      allow get, list: if true; // TODO: Should be restricted to startup memebrs
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    // Global helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
  }
}