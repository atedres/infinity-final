rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Authentication is required for almost every operation.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces user ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId and the resource exists.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces user ownership and resource existence for updates and deletes.
     */
    function isExistingOwner(userId) {
      return isOwner(userId);
    }

    /**
     * @description Checks if the authenticated user is a member of the startup with the given role.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces role-based access control for startups.
     */
    function isStartupMember(startupId, role) {
      return isSignedIn() && get(/databases/$(database)/documents/startups/$(startupId)).data.members[request.auth.uid] == role;
    }

    /**
     * @description Checks if the authenticated user is the owner of the startup, based on the resource data.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces ownership of a resource by checking a field within the resource.
     */
    function isResourceOwner(ownerId) {
      return isSignedIn() && request.auth.uid == ownerId;
    }

    /**
     * @description Rules for Startup documents.
     * @path /startups/{startupId}
     * @allow (create) User with matching ID can create their own Startup.
     * @deny (update) User cannot update a Startup if they are not the owner.
     * @principle Enforces document ownership for writes.
     */
    match /startups/{startupId} {
      allow get: if true;
      allow list: if true;

      allow create: if isSignedIn();
      allow update: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for Milestone documents under a Startup.
     * @path /startups/{startupId}/milestones/{milestoneId}
     * @allow (create) Members of the startup can create milestones.
     * @deny (update) Non-members cannot update milestones.
     * @principle Enforces role-based access control for milestones.
     */
    match /startups/{startupId}/milestones/{milestoneId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isStartupMember(startupId, 'editor');
      allow update: if isStartupMember(startupId, 'editor');
      allow delete: if isStartupMember(startupId, 'admin');
    }

    /**
     * @description Rules for Course documents.
     * @path /courses/{courseId}
     * @allow (get) Anyone can read courses.
     * @deny (create) Only the server can create courses.
     * @principle Public read access with restricted writes.
     */
    match /courses/{courseId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false; // TODO: Restrict create/update/delete to server only using custom claims.
    }

    /**
     * @description Rules for Freelancer documents.
     * @path /freelancers/{freelancerId}
     * @allow (get) Anyone can read freelancer profiles.
     * @deny (create) Only the server can create freelancer profiles.
     * @principle Public read access with restricted writes.
     */
    match /freelancers/{freelancerId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false; // TODO: Restrict create/update/delete to server only using custom claims.
    }

    /**
     * @description Rules for Project documents under a Startup.
     * @path /startups/{startupId}/projects/{projectId}
     * @allow (create) Members of the startup can create projects.
     * @deny (update) Non-members cannot update projects.
     * @principle Enforces role-based access control for projects.
     */
    match /startups/{startupId}/projects/{projectId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isStartupMember(startupId, 'editor');
      allow update: if isStartupMember(startupId, 'editor');
      allow delete: if isStartupMember(startupId, 'admin');
    }

    /**
     * @description Rules for User documents.
     * @path /users/{userId}
     * @allow (create) User with matching ID can create their own User document.
     * @deny (update) User cannot update a User document if they are not the owner.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for Post documents under a User.
     * @path /users/{userId}/posts/{postId}
     * @allow (create) User with matching ID can create posts under their User document.
     * @deny (update) User cannot update posts under another User document.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/posts/{postId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for Company documents.
     * @path /companies/{companyId}
     * @allow (create) Anyone can create a company.
     * @deny (update) Only the server can update company information.
     * @principle Restricted writes, open reads.
     */
    match /companies/{companyId} {
      allow get: if true;
      allow list: if true;

      allow create: if isSignedIn();
      allow update: if false; // TODO: Restrict create/update/delete to server only using custom claims or owner.
      allow delete: if false; // TODO: Restrict create/update/delete to server only using custom claims or owner.
    }

    /**
     * @description Rules for Ticket documents under a Company.
     * @path /companies/{companyId}/tickets/{ticketId}
     * @allow (create) Members of the company can create tickets.
     * @deny (update) Non-members cannot update tickets.
     * @principle Enforces role-based access control for tickets.
     */
    match /companies/{companyId}/tickets/{ticketId} {
      allow get: if true; // TODO: Adjust get permission appropriately.
      allow list: if true; // TODO: Adjust get permission appropriately.

      allow create: if isSignedIn(); // TODO: Restrict to company members.
      allow update: if isSignedIn(); // TODO: Restrict to company members.
      allow delete: if isSignedIn(); // TODO: Restrict to company members.
    }

    /**
     * @description Rules for TeamMember documents under a Company.
     * @path /companies/{companyId}/teamMembers/{teamMemberId}
     * @allow (create) Members of the company can create team members.
     * @deny (update) Non-members cannot update team members.
     * @principle Enforces role-based access control for team members.
     */
    match /companies/{companyId}/teamMembers/{teamMemberId} {
      allow get: if true; // TODO: Adjust get permission appropriately.
      allow list: if true; // TODO: Adjust get permission appropriately.

      allow create: if isSignedIn(); // TODO: Restrict to company members.
      allow update: if isSignedIn(); // TODO: Restrict to company members.
      allow delete: if isSignedIn(); // TODO: Restrict to company members.
    }

    /**
     * @description Rules for User-specific Signal documents.
     * @path /users/{userId}/signals/{signalId}
     * @allow (create) User with matching ID can create signal under their User document.
     * @deny (update) User cannot update signal under another User document.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/signals/{signalId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for Startup-specific Signal documents.
     * @path /startups/{startupId}/signals/{signalId}
     * @allow (create) Members of the startup can create signal under their Startup document.
     * @deny (update) User cannot update signal under another Startup document.
     * @principle Enforces document membership for writes.
     */
    match /startups/{startupId}/signals/{signalId} {
      allow get: if isStartupMember(startupId, 'viewer');
      allow list: if isStartupMember(startupId, 'viewer');

      allow create: if isStartupMember(startupId, 'editor');
      allow update: if isStartupMember(startupId, 'editor');
      allow delete: if isStartupMember(startupId, 'admin');
    }
  }
}